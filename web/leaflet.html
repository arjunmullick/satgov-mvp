<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>SatGov MVP Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
      html, body, #map { height: 100%; margin: 0; }
      #panel { position: absolute; top: 10px; right: 10px; background: #fff; padding: 8px; z-index: 1000; }
      #panel input[type="range"] { width: 160px; }
    </style>
  </head>
  <body>
    <div id="map"></div>
    <div id="panel">
      <button onclick="setLayer('ndvi')">NDVI</button>
      <button onclick="setLayer('ndwi')">NDWI</button>
      <button onclick="showOverlay('ndvi')">Overlay Demo</button>
      <button onclick="showTiles()">Back to Tiles</button>
      <div>
        Opacity: <input id="opacity" type="range" min="0" max="1" step="0.05" value="0.7" />
      </div>
      <div id="info"></div>
    </div>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
      const map = L.map('map').setView([15.4, 73.9], 9);
      L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);
      let overlay = null; // tile overlay
      let imageOverlay = null; // image overlay
      function setLayer(name) {
        if (imageOverlay) { map.removeLayer(imageOverlay); imageOverlay = null; }
        if (overlay) map.removeLayer(overlay);
        overlay = L.tileLayer('/tiles/' + name + '/{z}/{x}/{y}.png', {
          maxZoom: 19,
          maxNativeZoom: 0,
          opacity: parseFloat(document.getElementById('opacity').value)
        }).addTo(map);
      }
      async function showOverlay(name) {
        // Fetch overlay URL and bounds from API; add ImageOverlay
        try {
          const res = await fetch('/overlay/' + name);
          const j = await res.json();
          const url = j.url;
          const b = j.bounds; // [[south, west], [north, east]]
          if (overlay) { map.removeLayer(overlay); overlay = null; }
          if (imageOverlay) { map.removeLayer(imageOverlay); imageOverlay = null; }
          imageOverlay = L.imageOverlay(url, b, {opacity: parseFloat(document.getElementById('opacity').value)}).addTo(map);
          map.fitBounds(b);
        } catch (e) {
          alert('Overlay not available. Run the pipeline first via /ingest.');
        }
      }
      function showTiles() {
        setLayer('ndvi');
      }
      setLayer('ndvi');
      document.getElementById('opacity').addEventListener('input', (e) => {
        if (overlay) overlay.setOpacity(parseFloat(e.target.value));
      });
    </script>
  </body>
  </html>
